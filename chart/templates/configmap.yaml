apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway.fullname" . }}-config
  labels:
    {{- include "gateway.labels" . | nindent 4 }}
data:
  velocity.toml: |
    # Velocity Configuration
    # Generated by Helm

    config-version = "2.7"
    bind = {{ .Values.config.velocity.bind | quote }}
    motd = {{ .Values.config.velocity.motd | quote }}
    show-max-players = {{ .Values.config.velocity.showMaxPlayers }}
    online-mode = {{ .Values.config.velocity.onlineMode }}
    force-key-authentication = true
    prevent-client-proxy-connections = false
    player-info-forwarding-mode = {{ .Values.config.velocity.playerInfoForwardingMode | quote }}
    forwarding-secret-file = "forwarding.secret"
    announce-forge = false
    kick-existing-players = false
    ping-passthrough = "DISABLED"
    enable-player-address-logging = true

    [servers]
    {{- range $name, $server := .Values.config.velocity.servers }}
    {{ $name }} = {{ $server.address | quote }}
    {{- end }}

    try = [
    {{- $tries := .Values.config.velocity.try }}
    {{- range $i, $server := $tries }}
      {{ $server | quote }}{{ if lt $i (sub (len $tries) 1) }},{{ end }}
    {{- end }}
    ]

    [forced-hosts]
    {{- range $host, $server := .Values.config.velocity.forcedHosts }}
    {{ $host | quote }} = [{{ $server | quote }}]
    {{- end }}

    [advanced]
    compression-threshold = 256
    compression-level = -1
    login-ratelimit = 3000
    connection-timeout = 5000
    read-timeout = 30000
    haproxy-protocol = {{ .Values.config.velocity.haproxyProtocol | default false }}
    tcp-fast-open = false
    bungee-plugin-message-channel = true
    show-ping-requests = false
    failover-on-unexpected-server-disconnect = true
    announce-proxy-commands = true
    log-command-executions = false
    log-player-connections = true
    accepts-transfers = false

    [query]
    enabled = false
    port = 25565
    map = "Velocity"
    show-plugins = false

  # Plugin configuration files
  # Each plugin can have multiple config files
  {{- range $pluginName, $pluginConfigs := .Values.config.plugins }}
  {{- range $fileName, $content := $pluginConfigs }}
  plugin-{{ $pluginName }}-{{ $fileName | replace "." "-" }}: |
{{ $content | indent 4 }}
  {{- end }}
  {{- end }}
