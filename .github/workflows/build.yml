name: Build

on:
  push:
    branches: [main]
    paths:
      - 'docker/**'
      - 'plugins.yaml'
      - 'plugins.lock.yaml'
      - 'chart/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default: CalVer YYYY.M.D)'
        required: false
        type: string

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: primcraft/gateway

jobs:
  build:
    runs-on: arc-primcraft  # Self-hosted ARM64 runner
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install tools
        run: |
          mkdir -p $HOME/.local/bin
          # Install yq (not pre-installed on self-hosted runner)
          curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_arm64 -o $HOME/.local/bin/yq
          chmod +x $HOME/.local/bin/yq
          # Install AWS CLI (not pre-installed on self-hosted runner)
          curl -sL "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          ./aws/install --bin-dir $HOME/.local/bin --install-dir $HOME/.local/aws-cli --update
          rm -rf aws awscliv2.zip
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate version tag
        id: version
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            VERSION="${{ inputs.tag }}"
          else
            VERSION=$(date +%Y.%-m.%-d)
            # Add build number if multiple builds same day
            EXISTING=$(aws ecr describe-images \
              --repository-name ${{ env.ECR_REPOSITORY }} \
              --query "imageDetails[?starts_with(imageTags[0], '${VERSION}')].imageTags[0]" \
              --output text 2>/dev/null || echo "")
            if [ -n "$EXISTING" ] && [ "$EXISTING" != "None" ]; then
              COUNT=$(echo "$EXISTING" | wc -w | tr -d ' ')
              VERSION="${VERSION}.${COUNT}"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push
        run: |
          docker build -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }} \
                       -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest \
                       --build-arg USE_LOCK_FILE=true \
                       -f docker/Dockerfile .
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

      - name: Update chart version
        run: |
          yq -i '.version = "${{ steps.version.outputs.version }}"' chart/Chart.yaml
          cat chart/Chart.yaml

      - name: Generate release notes
        id: notes
        run: |
          # Extract versions from lockfile
          echo "## Components" > notes.md
          echo "" >> notes.md

          # Velocity version
          VELOCITY_URL=$(yq -r '.velocity.url' plugins.lock.yaml)
          VELOCITY_VER=$(echo "$VELOCITY_URL" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+-[^/]+' | head -1)
          echo "- **Velocity**: ${VELOCITY_VER:-latest}" >> notes.md

          # Plugin versions
          echo "" >> notes.md
          echo "## Plugins" >> notes.md
          echo "" >> notes.md
          for plugin in $(yq -r '.plugins | keys | .[]' plugins.lock.yaml); do
            version=$(yq -r ".plugins.${plugin}.version" plugins.lock.yaml)
            echo "- **${plugin}**: ${version}" >> notes.md
          done

          cat notes.md

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Gateway ${{ steps.version.outputs.version }}
          body_path: notes.md
          make_latest: true

      - name: Commit chart version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add chart/Chart.yaml
          git commit -m "Update chart version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push

      - name: Summary
        run: |
          echo "### Build Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
